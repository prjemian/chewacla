chewacla.adhoc
==============

.. py:module:: chewacla.adhoc

.. autoapi-nested-parse::

   Chewacla: *ad hoc* diffractometer with rotation stages described by the caller.

   This module provides a lightweight, dictionary-driven representation of a
   diffractometer and supporting types used for small, interactive workflows.

   Key classes
   -----------
   - :class:`~chewacla.adhoc.Chewacla`: *ad hoc* diffractometer.
   - :class:`~chewacla.adhoc.AHReflection`: orienting reflection: (h,k,l) & angles (& optional wavelength).

   .. rubric:: Example

   Construct a simple *Chewacla* diffractometer and add a reflection:

   .. code-block:: python
       :linenos:

       from chewacla.adhoc import Chewacla, AHReflection

       c = Chewacla({"s": "y+"}, {"d": "y+"})
       c.lattice = 1, 1, 1, 90, 90, 90
       r = AHReflection("one", {"h": 1, "k": 0, "l": 0}, {"s": 14.4, "d": 28.8})
       c.addReflection(r)

   Utilities
   ---------
   - ``expand_direction_map``: expand shorthand direction codes (``'x+'``, ``'y-'``)
       into unit vectors using the `DirectionShorthand` vocabulary.









Module Contents
---------------

.. py:data:: TAU

   Prefactor, either 1 or 2 pi

.. py:data:: DEFAULT_WAVELENGTH
   :value: 1.54


   Approximately copper K-alpha in angstroms.

.. py:data:: DEFAULT_LATTICE_PARAMS
   :value: (1, 1, 1, 90, 90, 90)


   Trivial cubic crystal.

.. py:function:: _validate_length(name: str, val: float) -> None

.. py:function:: _validate_angle(name: str, val: float) -> None

.. py:function:: _validated_setter(attr_name: str, validator)

   Decorator for property setters: convert to float, validate, set internal
   _<attr_name>, and invalidate cached self._B.


.. py:function:: _compare_axis_sets(kind: str, reflection_name: str, defined: set, given: set) -> None

   Compare two sets of axis/key names and raise ValueError on mismatch.

   :param kind: 'real' or 'pseudo' — selects wording for the error message.
   :param reflection_name: Name of the reflection for error context.
   :param defined: The canonical set of names expected by the instrument.
   :param given: The set of names provided by the reflection.

   :raises ValueError: If the given set does not exactly match the defined set.


.. py:function:: expand_direction_map(ds: chewacla.shorthand.DirectionShorthand, stage_map: chewacla.shorthand.DirectionMapInput) -> Dict[str, numpy.ndarray]

   Return dict: {axis name: direction} where shorthand is direction, a unit vector.

   Example::

       ds = DirectionShorthand()
       rotation_axes = {"a": "x+", "b": "y-", "c": "z+"}
       expanded = expand_direction_map(ds, rotation_axes)
       # expanded -> {"a": array([1.,0.,0.]), "b": array([0.,-1.,0.]), ...}


.. py:class:: _AHLattice(a: numbers.Real, b: numbers.Real, c: numbers.Real, alpha: numbers.Real, beta: numbers.Real, gamma: numbers.Real)

   Internal container for lattice parameters and B-matrix computation.


   .. py:property:: a
      :type: float



   .. py:property:: b
      :type: float



   .. py:property:: c
      :type: float



   .. py:property:: alpha
      :type: float



   .. py:property:: beta
      :type: float



   .. py:property:: gamma
      :type: float



   .. py:attribute:: _B
      :type:  Optional[numpy.ndarray]

      Crystalline sample orientation matrix.


   .. py:attribute:: digits
      :type:  int | None
      :value: None


      Display precision (number of digits), default is full precision.


   .. py:property:: B
      :type: numpy.ndarray


      Return the lattice B matrix (3x3 ndarray) [per BL67].

      * BL67: Busing&Levy Acta Cyst. 22, 457 (1967)
      * https://repo.or.cz/hkl.git/blob/HEAD:/hkl/hkl-lattice.c

      Compute the reciprocal-lattice B matrix from unit-cell parameters.
      This matrix depends only on the crystal cell parameters.

      Input Units:

      * angles alpha, beta, gamma are given in degrees
      * a, b, c are in the same units as the wavelength

      :returns: (3,3) numpy.ndarray (float64)
      :rtype: B

      :raises ValueError: if the cell is degenerate (invalid angles/parameters).

      .. note::

         This implementation uses the Busing & Levy convention and includes the
         factor 2π (TAU) so that G = B @ h has units of Å⁻¹.


   .. py:method:: to_dict(digits: Optional[int] = None) -> Dict[str, float]

      Return lattice constants as a dict.

      If `digits` is an int, numeric values are rounded to that many decimal places.
      If `digits` is None (default), full precision floats are returned.



   .. py:method:: __repr__() -> str

      Nice text representation.



.. py:class:: AHReflection(name: str, pseudos: collections.abc.Mapping[str, float], reals: collections.abc.Mapping[str, float], wavelength: Optional[float] = None)

   Orienting reflection used by the AdHocDiffractometer.


   .. py:attribute:: _name
      :type:  str

      (internal) name given to this reflection by the caller.


   .. py:attribute:: _pseudos
      :type:  Dict[str, float]

      (internal) dict of pseudo-axis names to float values (e.g., h,k,l).


   .. py:attribute:: _reals
      :type:  Dict[str, float]

      (internal) dict of real-axis names to float values (diffractometer angles).


   .. py:attribute:: _wavelength
      :type:  float

      (internal) Wavelength associated with this reflection (in length units, typically Å).


   .. py:property:: pseudos
      :type: collections.abc.Mapping[str, float]


      Read-only view of pseudos (hkl) mapping.


   .. py:property:: reals
      :type: collections.abc.Mapping[str, float]


      Read-only view of reals mapping.


   .. py:property:: wavelength
      :type: float


      Wavelength (float).


   .. py:property:: name
      :type: str


      Name given to this reflection (read-only).


   .. py:method:: set_pseudo(name: str, value: float) -> None

      Set a single pseudo value.



   .. py:method:: get_pseudo(name: str, default: Optional[float] = None) -> Optional[float]

      Get a single pseudo value or default if missing.



   .. py:method:: remove_pseudo(name: str) -> None

      Remove a pseudo entry; KeyError if absent.



   .. py:method:: set_real(name: str, value: float) -> None

      Set a single real value.



   .. py:method:: get_real(name: str, default: Optional[float] = None) -> Optional[float]

      Get a single real value or default if missing.



   .. py:method:: remove_real(name: str) -> None

      Remove a real entry; KeyError if absent.



   .. py:method:: __repr__() -> str

      Nice, truncated text representation for long dicts.



   .. py:method:: __eq__(other: object) -> bool

      Compare with 'other' reflection for equality with numeric tolerance.



   .. py:method:: validate_against(expected_reals: Optional[collections.abc.Sequence[str]] = None, expected_pseudos: Optional[collections.abc.Sequence[str]] = None) -> None

      Validate this reflection's keys against expected instrument axes.

      :param expected_reals: Sequence of real-axis names expected by the instrument (e.g. sample/detector axes).
      :param expected_pseudos: Sequence of pseudo-axis keys expected (usually 'h','k','l').

      :raises ValueError: If the reflection's keys do not exactly match the expected sets.



.. py:class:: Chewacla(sample_stage: chewacla.shorthand.DirectionMapInput, detector_stage: chewacla.shorthand.DirectionMapInput, wavelength: Optional[float] = None, incident_beam: Optional[chewacla.shorthand.DirectionVectorInput] = None, direction_map: Optional[chewacla.shorthand.DirectionMapInput] = None)

   The *ad hoc* diffractometer with stages as described by a dictionary.

   .. rubric:: Notes

   - Reflections are managed by name. Use :meth:`addReflection` to add an
       :class:`AHReflection` to the instrument. By default adding a reflection
       with a name that already exists raises ``ValueError`` to prevent
       accidental overwrites; pass ``force=True`` to replace an existing
       reflection deliberately.


   .. py:attribute:: _incident_beam
      :type:  chewacla.shorthand.DirectionVector

      Unit vector describing the direction of the incident beam.


   .. py:attribute:: _sample_stage
      :type:  chewacla.shorthand.DirectionMap

      names and unit vectors for sample stage rotations


   .. py:attribute:: _detector_stage
      :type:  chewacla.shorthand.DirectionMap

      names and unit vectors for detector stage rotations


   .. py:attribute:: _lattice
      :type:  _AHLattice

      crystal lattice parameters (angstroms and degrees)


   .. py:attribute:: _wavelength
      :type:  float

      Wavelength of incident beam (angstroms)


   .. py:attribute:: _reflections
      :type:  Dict[str, AHReflection]

      Orienting reflections (name -> AHReflection) to be used in computation of UB matrix.


   .. py:attribute:: U
      :type:  numpy.ndarray

      Goniometer orientation matrix


   .. py:attribute:: UB
      :type:  numpy.ndarray

      Crystal orientation matrix


   .. py:attribute:: _ds
      :type:  chewacla.shorthand.DirectionShorthand

      (internal) DirectionShorthand object


   .. py:attribute:: raw_incident_beam
      :value: None



   .. py:attribute:: raw_sample_stage
      :value: None



   .. py:attribute:: raw_detector_stage
      :value: None



   .. py:property:: incident_beam
      :type: chewacla.shorthand.DirectionVector


      Unit vector describing the direction of the incident beam.


   .. py:property:: sample_stage
      :type: chewacla.shorthand.DirectionMap


      Describes the sample stage stack of rotations.


   .. py:property:: detector_stage
      :type: chewacla.shorthand.DirectionMap


      Describes the detector stage stack of rotations.


   .. py:property:: wavelength
      :type: float



   .. py:property:: lattice
      :type: _AHLattice


      Return the Lattice object.


   .. py:method:: __repr__() -> str

      Nice text representation.



   .. py:method:: addReflection(reflection: AHReflection, force: bool = False) -> None

      Add a single reflection using its own `name` attribute as the key.

      Parameters:

      - reflection: an already-constructed `AHReflection` instance with a valid
        `name` attribute (str). The reflection's `name` will be used as the key
        when storing it in the manager.



   .. py:method:: make_reflection(name: str, pseudos: collections.abc.Mapping[str, float], reals: collections.abc.Mapping[str, float], wavelength: Optional[float] = None) -> AHReflection

      Factory: construct and validate an AHReflection using this instrument's axes.

      The returned AHReflection has already been validated against the Chewacla
      `real_axis_names` and `pseudo_axis_names`.



   .. py:method:: calc_UB_BL67() -> numpy.ndarray

      Calculate the U & UB matrices from the given reflections.



   .. py:method:: forward(pseudos: Dict[str, float]) -> collections.abc.Sequence[Dict[str, float]]


   .. py:method:: inverse(reals: Dict[str, float]) -> Dict[str, float]


   .. py:property:: pseudo_axis_names
      :type: list[str]


      List of the pseudo axis names.


   .. py:property:: real_axis_names
      :type: list[str]


      List of the real axis names.


   .. py:property:: reflections
      :type: dict


      Return the reflection mapping (name -> AHReflection).


